title = "Residuals vs Fitted",
x = "Fitted values",
y = "Residuals"
) +
theme_slide
# 2) Normal Q–Q
p2 <- ggplot2::ggplot(aug, ggplot2::aes(sample = .std.resid)) +
ggplot2::stat_qq(color = colors$points, alpha = 0.25) +
ggplot2::stat_qq_line(ggplot2::aes(color = "Q–Q reference")) +
ggplot2::scale_color_manual(name = NULL, values = legend_colors) +
ggplot2::labs(
title = "Normal Q–Q",
x = "Theoretical quantiles",
y = "Standardized residuals"
) +
theme_slide
# 3) Scale–Location
p3 <- ggplot2::ggplot(aug, ggplot2::aes(.fitted, sqrt_abs_std_resid)) +
ggplot2::geom_point(color = colors$points, alpha = 0.25) +
ggplot2::geom_smooth(
ggplot2::aes(color = "LOESS smooth"),
method = "loess",
se = FALSE
) +
ggplot2::scale_color_manual(name = NULL, values = legend_colors) +
ggplot2::labs(
title = "Scale–Location",
x = "Fitted values",
y = expression(sqrt("|Standardized residuals|"))
) +
theme_slide
# 4) Residuals vs Leverage (+ Cook's contours)
n <- stats::nobs(fit)
p <- length(stats::coef(fit))
cook_levels <- c(0.5, 1)
cook_contour <- function(h, c, p) sqrt(c * p * (1 - h) / h)
h_grid <- seq(
max(1e-6, min(aug$.hat, na.rm = TRUE)),
max(aug$.hat, na.rm = TRUE),
length.out = 300
)
contour_df <- dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
})) %>%
dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = -cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
}))
p4 <- ggplot2::ggplot(aug, ggplot2::aes(.hat, .std.resid)) +
ggplot2::geom_point(ggplot2::aes(size = .cooksd), color = colors$points, alpha = 0.25) +
ggplot2::scale_size_continuous(range = c(1, 6), guide = "none") +
ggplot2::geom_hline(
ggplot2::aes(yintercept = 0, color = "Reference (y = 0)"),
linetype = 2
) +
ggplot2::geom_vline(xintercept = 2 * p / n, linetype = 3, color = colors$reference) +
ggplot2::geom_line(
data = contour_df,
mapping = ggplot2::aes(.hat, y, linetype = level),
color = colors$cooks_contours,
inherit.aes = FALSE
) +
ggplot2::scale_linetype_discrete(name = NULL) +
ggrepel::geom_text_repel(
data = lab,
ggplot2::aes(label = obs),
color = colors$labels,
size = 3,
max.overlaps = Inf
) +
ggplot2::scale_color_manual(name = NULL, values = legend_colors) +
ggplot2::labs(
title = "Residuals vs Leverage",
x = "Leverage (hat values)",
y = "Standardized residuals"
) +
theme_slide
# Return a 2×2 patchwork object
(p1 | p2) / (p3 | p4)
}
# Plot MLR diagnostics with custom colors
gg_lm_diagnostics(
mlr_fit,
colors = list(
points = "#0072B2",
smooth = "#D55E00",
reference = "#999999",
qq_line = "#333333",
cooks_contours = "#666666",
labels = "#111111"
)
)
gg_lm_diagnostics <- function(
fit,
label_top = 5,
show_cooks = TRUE,
colors = list(
points = "#2C7BB6",
loess = "#D55E00",
ref = "gray40",
qq = "gray40",
cooks = "gray55",
labels = "black"
)
) {
# Required: ggplot2, broom, dplyr, ggrepel, patchwork
aug <- broom::augment(fit) %>%
dplyr::mutate(
sqrt_abs_std_resid = sqrt(abs(.std.resid)),
obs = dplyr::row_number()
)
lab <- aug %>% dplyr::slice_max(.cooksd, n = label_top)
# Smaller, multi-panel-friendly theme
theme_diag <- ggplot2::theme_minimal(base_size = 10) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
axis.title = ggplot2::element_text(size = 10),
axis.text = ggplot2::element_text(size = 9),
legend.position = "bottom",
legend.title = ggplot2::element_blank(),
legend.text = ggplot2::element_text(size = 9),
plot.margin = ggplot2::margin(6, 6, 6, 6)
)
legend_colors <- c(
"LOESS smooth" = colors$loess,
"Reference (y = 0)" = colors$ref,
"Q–Q reference" = colors$qq
)
# 1) Residuals vs Fitted
p1 <- ggplot2::ggplot(aug, ggplot2::aes(.fitted, .resid)) +
ggplot2::geom_point(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::geom_smooth(
ggplot2::aes(color = "LOESS smooth"),
method = "loess", se = FALSE, linewidth = 1
) +
ggplot2::geom_hline(
ggplot2::aes(yintercept = 0, color = "Reference (y = 0)"),
linetype = 2, linewidth = 0.8
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(title = "Residuals vs Fitted", x = "Fitted values", y = "Residuals") +
theme_diag
# 2) Normal Q–Q
p2 <- ggplot2::ggplot(aug, ggplot2::aes(sample = .std.resid)) +
ggplot2::stat_qq(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::stat_qq_line(ggplot2::aes(color = "Q–Q reference"), linewidth = 0.9) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(title = "Normal Q–Q", x = "Theoretical quantiles", y = "Standardized residuals") +
theme_diag
# 3) Scale–Location
p3 <- ggplot2::ggplot(aug, ggplot2::aes(.fitted, sqrt_abs_std_resid)) +
ggplot2::geom_point(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::geom_smooth(
ggplot2::aes(color = "LOESS smooth"),
method = "loess", se = FALSE, linewidth = 1
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(
title = "Scale–Location",
x = "Fitted values",
y = expression(sqrt("|Standardized residuals|"))
) +
theme_diag
# 4) Residuals vs Leverage
n <- stats::nobs(fit)
p <- length(stats::coef(fit))
p4 <- ggplot2::ggplot(aug, ggplot2::aes(.hat, .std.resid)) +
ggplot2::geom_point(
ggplot2::aes(size = .cooksd),
color = colors$points,
alpha = 0.35
) +
ggplot2::scale_size_continuous(range = c(1.2, 5), guide = "none") +
ggplot2::geom_hline(
ggplot2::aes(yintercept = 0, color = "Reference (y = 0)"),
linetype = 2, linewidth = 0.8
) +
ggplot2::geom_vline(
xintercept = 2 * p / n,
linetype = 3,
color = colors$ref,
linewidth = 0.8
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(
title = "Residuals vs Leverage",
x = "Leverage (hat values)",
y = "Standardized residuals"
) +
theme_diag
# Optional Cook's contours (often clutters; keep toggle)
if (show_cooks) {
cook_levels <- c(0.5, 1)
cook_contour <- function(h, c, p) sqrt(c * p * (1 - h) / h)
h_grid <- seq(
max(1e-6, min(aug$.hat, na.rm = TRUE)),
max(aug$.hat, na.rm = TRUE),
length.out = 250
)
contour_df <- dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
})) %>%
dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = -cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
}))
p4 <- p4 +
ggplot2::geom_line(
data = contour_df,
ggplot2::aes(.hat, y, linetype = level),
color = colors$cooks,
inherit.aes = FALSE,
linewidth = 0.8
) +
ggplot2::scale_linetype_discrete(name = NULL)
}
# Label only a few influential points
p4 <- p4 +
ggrepel::geom_text_repel(
data = lab,
ggplot2::aes(label = obs),
color = colors$labels,
size = 3,
max.overlaps = Inf
)
# Build 2×2 and collect legends into one
(p1 | p2) / (p3 | p4) +
patchwork::plot_layout(guides = "collect") &
ggplot2::theme(legend.position = "bottom")
}
# Example:
# gg_lm_diagnostics(mlr_fit)
gg_lm_diagnostics(mlr_fit, show_cooks = FALSE)
gg_lm_diagnostics <- function(
fit,
label_top = 5,
show_cooks = TRUE,
colors = list(
points = "#2C7BB6",
loess = "#D55E00",
ref = "gray40",
qq = "gray40",
cooks = "gray55",
labels = "black"
)
) {
# Required: ggplot2, broom, dplyr, ggrepel, patchwork
aug <- broom::augment(fit) %>%
dplyr::mutate(
sqrt_abs_std_resid = sqrt(abs(.std.resid)),
obs = dplyr::row_number()
)
lab <- aug %>% dplyr::slice_max(.cooksd, n = label_top)
# Smaller, multi-panel-friendly theme
theme_diag <- ggplot2::theme_minimal(base_size = 10) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
axis.title = ggplot2::element_text(size = 10),
axis.text = ggplot2::element_text(size = 9),
legend.position = "bottom",
legend.title = ggplot2::element_blank(),
legend.text = ggplot2::element_text(size = 9),
plot.margin = ggplot2::margin(6, 6, 6, 6)
)
legend_colors <- c(
"LOESS smooth" = colors$loess,
"Reference (y = 0)" = colors$ref,
"Q–Q reference" = colors$qq
)
# 1) Residuals vs Fitted
p1 <- ggplot2::ggplot(aug, ggplot2::aes(.fitted, .resid)) +
ggplot2::geom_point(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::geom_smooth(
ggplot2::aes(color = "LOESS smooth"),
method = "loess", se = FALSE, linewidth = 1
) +
ggplot2::geom_hline(
ggplot2::aes(yintercept = 0, color = "Reference (y = 0)"),
linetype = 2, linewidth = 0.8
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(title = "Residuals vs Fitted", x = "Fitted values", y = "Residuals") +
theme_diag
# 2) Normal Q–Q
p2 <- ggplot2::ggplot(aug, ggplot2::aes(sample = .std.resid)) +
ggplot2::stat_qq(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::stat_qq_line(ggplot2::aes(color = "Q–Q reference"), linewidth = 0.9) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(title = "Normal Q–Q", x = "Theoretical quantiles", y = "Standardized residuals") +
theme_diag +
theme(legend.position = "none")
# 3) Scale–Location
p3 <- ggplot2::ggplot(aug, ggplot2::aes(.fitted, sqrt_abs_std_resid)) +
ggplot2::geom_point(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::geom_smooth(
ggplot2::aes(color = "LOESS smooth"),
method = "loess", se = FALSE, linewidth = 1
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(
title = "Scale–Location",
x = "Fitted values",
y = expression(sqrt("|Standardized residuals|"))
) +
theme_diag +
theme(legend.position = "none")
# 4) Residuals vs Leverage
n <- stats::nobs(fit)
p <- length(stats::coef(fit))
p4 <- ggplot2::ggplot(aug, ggplot2::aes(.hat, .std.resid)) +
ggplot2::geom_point(
ggplot2::aes(size = .cooksd),
color = colors$points,
alpha = 0.35
) +
ggplot2::scale_size_continuous(range = c(1.2, 5), guide = "none") +
ggplot2::geom_hline(
ggplot2::aes(yintercept = 0, color = "Reference (y = 0)"),
linetype = 2, linewidth = 0.8
) +
ggplot2::geom_vline(
xintercept = 2 * p / n,
linetype = 3,
color = colors$ref,
linewidth = 0.8
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(
title = "Residuals vs Leverage",
x = "Leverage (hat values)",
y = "Standardized residuals"
) +
theme_diag +
theme(legend.position = "none")
# Optional Cook's contours (often clutters; keep toggle)
if (show_cooks) {
cook_levels <- c(0.5, 1)
cook_contour <- function(h, c, p) sqrt(c * p * (1 - h) / h)
h_grid <- seq(
max(1e-6, min(aug$.hat, na.rm = TRUE)),
max(aug$.hat, na.rm = TRUE),
length.out = 250
)
contour_df <- dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
})) %>%
dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = -cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
}))
p4 <- p4 +
ggplot2::geom_line(
data = contour_df,
ggplot2::aes(.hat, y, linetype = level),
color = colors$cooks,
inherit.aes = FALSE,
linewidth = 0.8
) +
ggplot2::scale_linetype_discrete(name = NULL)
}
# Label only a few influential points
p4 <- p4 +
ggrepel::geom_text_repel(
data = lab,
ggplot2::aes(label = obs),
color = colors$labels,
size = 3,
max.overlaps = Inf
)
# Build 2×2 and collect legends into one
(p1 | p2) / (p3 | p4) +
patchwork::plot_layout(guides = "collect") &
ggplot2::theme(legend.position = "bottom")
}
# Example:
# gg_lm_diagnostics(mlr_fit)
gg_lm_diagnostics(mlr_fit, show_cooks = FALSE)
gg_lm_diagnostics <- function(
fit,
label_top = 5,
show_cooks = TRUE,
colors = list(
points = "#2C7BB6",
loess = "#D55E00",
ref = "gray40",
qq = "gray40",
cooks = "gray55",
labels = "black"
)
) {
# Required: ggplot2, broom, dplyr, ggrepel, patchwork
aug <- broom::augment(fit) %>%
dplyr::mutate(
sqrt_abs_std_resid = sqrt(abs(.std.resid)),
obs = dplyr::row_number()
)
lab <- aug %>% dplyr::slice_max(.cooksd, n = label_top)
# Smaller, multi-panel-friendly theme
theme_diag <- ggplot2::theme_minimal(base_size = 10) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
axis.title = ggplot2::element_text(size = 10),
axis.text = ggplot2::element_text(size = 9),
legend.position = "bottom",
legend.title = ggplot2::element_blank(),
legend.text = ggplot2::element_text(size = 9),
plot.margin = ggplot2::margin(6, 6, 6, 6)
)
legend_colors <- c(
"LOESS smooth" = colors$loess,
"Reference (y = 0)" = colors$ref,
"Q–Q reference" = colors$qq
)
# 1) Residuals vs Fitted
p1 <- ggplot2::ggplot(aug, ggplot2::aes(.fitted, .resid)) +
ggplot2::geom_point(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::geom_smooth(
ggplot2::aes(color = "LOESS smooth"),
method = "loess", se = FALSE, linewidth = 1
) +
ggplot2::geom_hline(
ggplot2::aes(yintercept = 0, color = "Reference (y = 0)"),
linetype = 2, linewidth = 0.8
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(title = "Residuals vs Fitted", x = "Fitted values", y = "Residuals") +
theme_diag
# 2) Normal Q–Q
p2 <- ggplot2::ggplot(aug, ggplot2::aes(sample = .std.resid)) +
ggplot2::stat_qq(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::stat_qq_line(ggplot2::aes(color = "Q–Q reference"), linewidth = 0.9) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(title = "Normal Q–Q", x = "Theoretical quantiles", y = "Standardized residuals") +
theme_diag +
theme(legend.position = "none")
# 3) Scale–Location
p3 <- ggplot2::ggplot(aug, ggplot2::aes(.fitted, sqrt_abs_std_resid)) +
ggplot2::geom_point(color = colors$points, alpha = 0.35, size = 1.6) +
ggplot2::geom_smooth(
ggplot2::aes(color = "LOESS smooth"),
method = "loess", se = FALSE, linewidth = 1
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(
title = "Scale–Location",
x = "Fitted values",
y = expression(sqrt("|Standardized residuals|"))
) +
theme_diag +
theme(legend.position = "none")
# 4) Residuals vs Leverage
n <- stats::nobs(fit)
p <- length(stats::coef(fit))
p4 <- ggplot2::ggplot(aug, ggplot2::aes(.hat, .std.resid)) +
ggplot2::geom_point(
ggplot2::aes(size = .cooksd),
color = colors$points,
alpha = 0.35
) +
ggplot2::scale_size_continuous(range = c(1.2, 5), guide = "none") +
ggplot2::geom_hline(
ggplot2::aes(yintercept = 0, color = "Reference (y = 0)"),
linetype = 2, linewidth = 0.8
) +
ggplot2::geom_vline(
xintercept = 2 * p / n,
linetype = 3,
color = colors$ref,
linewidth = 0.8
) +
ggplot2::scale_color_manual(values = legend_colors) +
ggplot2::labs(
title = "Residuals vs Leverage",
x = "Leverage (hat values)",
y = "Standardized residuals"
) +
theme_diag +
theme(legend.position = "none")
# Optional Cook's contours (often clutters; keep toggle)
if (show_cooks) {
cook_levels <- c(0.5, 1)
cook_contour <- function(h, c, p) sqrt(c * p * (1 - h) / h)
h_grid <- seq(
max(1e-6, min(aug$.hat, na.rm = TRUE)),
max(aug$.hat, na.rm = TRUE),
length.out = 250
)
contour_df <- dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
})) %>%
dplyr::bind_rows(lapply(cook_levels, function(c) {
data.frame(.hat = h_grid, y = -cook_contour(h_grid, c, p), level = paste0("Cook's D = ", c))
}))
p4 <- p4 +
ggplot2::geom_line(
data = contour_df,
ggplot2::aes(.hat, y, linetype = level),
color = colors$cooks,
inherit.aes = FALSE,
linewidth = 0.8
) +
ggplot2::scale_linetype_discrete(name = NULL)
}
# Label only a few influential points
p4 <- p4 +
ggrepel::geom_text_repel(
data = lab,
ggplot2::aes(label = obs),
color = colors$labels,
size = 3,
max.overlaps = Inf
)
# Build 2×2 and collect legends into one
(p1 | p2) / (p3 | p4) +
patchwork::plot_layout(guides = "collect")
